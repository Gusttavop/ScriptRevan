// ==UserScript==
// @name         Máscara de Atendimento (corrigido)
// @namespace    http://tampermonkey.net/
// @version      1.4.5
// @description  Adiciona um botão flutuante que abre um sidebar com overlay controlado por uma variável global. Funções de automação otimizadas e confirmação final automática.
// @author       Você
// @match        https://revan-atendimento.brisanet.net.br/*
// @grant        GM_addStyle
// ==/UserScript==

(function () {
  "use strict";

  // Global state
  window.ItemSelectorState = {
    jsonData: [],
    availableTags: new Set(),
    selectedItem: null,
    mensagemFinal: "",
    elements: null,
    onItemSelectedCallback: null,
  };

  // Use only window.tagResult (padronizado)
  window.tagResult = false;

  // Add tagExt function to the global scope
  window.tagExt = () => {
    if (!window.ItemSelectorState?.selectedItem) {
      console.log("tagExt: nenhum item selecionado");
      return false;
    }

    const spans = Array.from(
      document.querySelectorAll("div.tags > div.tag > nz-tag > span")
    );
    const tags = spans.map(tag => tag.textContent?.trim()).filter(Boolean);
    // store on globalThis for compatibility with other scripts if necessary
    globalThis.globalAvailableTags = new Set(tags);
    console.log("Tags extraídas:", tags);

    const selectedTag = window.ItemSelectorState.selectedItem.etiqueta;
    const resultTag = globalThis.globalAvailableTags.has(selectedTag);
    console.log("Tag availability:", resultTag);
    if (!resultTag) {
      console.log("Iniciando sequência de ações para tag não disponível (tagExt)");
    }
    window.tagResult = resultTag;
    return resultTag;
  };

  // Global ItemSelector interface
  window.ItemSelector = {
    getSelectedItem: () => {
      if (!window.ItemSelectorState.selectedItem) {
        console.log("No item currently selected");
        return null;
      }
      return window.ItemSelectorState.selectedItem;
    },
    getFormattedMessage: () => {
      const message = window.construirMensagemFinal();
      if (!message) {
        console.log("No message available");
        return "";
      }
      return message;
    },
    getFormData: () => {
      const state = window.ItemSelectorState;
      if (!state.selectedItem) return null;
      const elements = state.elements;
      return {
        item: state.selectedItem,
        isHolder: !!elements.holderCheckbox.querySelector("input").checked,
        speaker: elements.speakerInput.value || "",
        relationship:
          elements.relationshipSelect.querySelector("select").value || "",
        observations: elements.observationsTextarea.value || "",
        isExternalCall:
          !!elements.externalCallCheckbox.querySelector("input").checked,
        hasReminder: !!elements.reminderCheckbox.querySelector("input").checked,
        isImportant: !!elements.importantCheckbox.querySelector("input").checked,
        finalMessage: window.construirMensagemFinal(),
      };
    },
    onItemSelected: callback => {
      if (typeof callback !== "function") return;
      window.ItemSelectorState.onItemSelectedCallback = callback;
    },
  };

  // Make construirMensagemFinal globally accessible
  window.construirMensagemFinal = () => {
    // Se 'mensagemFinal' tem um valor (salvo da edição), usa ele.
    if (window.ItemSelectorState.mensagemFinal) {
      return window.ItemSelectorState.mensagemFinal;
    }

    if (!window.ItemSelectorState.selectedItem) return "";

    let inicioMensagem = "";
    const holderCheckbox = window.ItemSelectorState.elements.holderCheckbox;
    const speakerInput = window.ItemSelectorState.elements.speakerInput;
    const relationshipSelect =
      window.ItemSelectorState.elements.relationshipSelect;

    if (holderCheckbox.querySelector("input").checked) {
      inicioMensagem = "Próprio titular - ";
    } else if (speakerInput.value) {
      const relationship = relationshipSelect.querySelector("select").value;
      inicioMensagem = `${speakerInput.value} - ${relationship} - `;
    } else {
      inicioMensagem = "Cliente - ";
    }

    const corpoMensagem = window.ItemSelectorState.selectedItem.mensagem || "";

    let finalMensagem = "";
    const observationsTextarea =
      window.ItemSelectorState.elements.observationsTextarea;
    if (observationsTextarea.value.trim()) {
      finalMensagem = ` Observação: ${observationsTextarea.value.trim()}`;
    }

    // Retorna a mensagem construída, que será usada se não houver 'mensagemFinal' salva.
    return `${inicioMensagem}${corpoMensagem}${finalMensagem}`.trim();
  };

  // Funções do Modal
  function openEditModal() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return console.error("openEditModal: elements não definido");
    
    // Prioriza a mensagem já editada ou constrói uma nova se for a primeira abertura
    const messageToEdit = window.ItemSelectorState.mensagemFinal || window.construirMensagemFinal();
    
    elements.editMessageTextarea.value = messageToEdit;
    elements.editModal.style.display = "block";
    elements.editMessageTextarea.focus();
    console.log("Modal de edição aberto.");
  }

  function closeEditModal() {
    const elements = window.ItemSelectorState.elements;
    if (elements?.editModal) elements.editModal.style.display = "none";
    console.log("Modal de edição fechado.");
  }

  function saveEdit() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return;

    // 1. Salva o valor da textarea na variável de estado que guarda a mensagem editada
    window.ItemSelectorState.mensagemFinal = elements.editMessageTextarea.value;
    
    // 2. Atualiza a pré-visualização para refletir a nova mensagem salva
    updatePreview();
    
    // 3. Fecha o modal
    closeEditModal();
    console.log("Mensagem editada salva no estado.");
  }


  function createElements() {
    const button = document.createElement("button");
    button.id = "openSidebarBtn";
    button.setAttribute("aria-label", "Abrir Máscara de Atendimento");
    button.innerHTML =
      '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M460-320v-320L300-480l160 160ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm440-80h120v-560H640v560Zm-80 0v-560H200v560h360Zm80 0h120-120Z"/></svg>';
    document.body.appendChild(button);

    const sidebar = document.createElement("div");
    sidebar.id = "sidebar";

    const header = document.createElement("header");
    header.textContent = "Máscara de Atendimento";
    sidebar.appendChild(header);

    const searchContainer = document.createElement("div");
    searchContainer.id = "searchContainer";

    const inputWrapper = document.createElement("div");
    inputWrapper.className = "input-wrapper";

    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.id = "searchInput";
    searchInput.placeholder = "Selecione um problema";

    const clearButton = document.createElement("button");
    clearButton.className = "clear-button";
    clearButton.innerHTML = "×";
    clearButton.style.display = "none";
    clearButton.setAttribute("aria-label", "Limpar seleção");

    inputWrapper.appendChild(searchInput);
    inputWrapper.appendChild(clearButton);
    searchContainer.appendChild(inputWrapper);
    sidebar.appendChild(searchContainer);

    const dropdown = document.createElement("ul");
    dropdown.id = "dropdown";
    dropdown.style.display = "none";
    sidebar.appendChild(dropdown);

    const specificationSection = document.createElement("div");
    specificationSection.id = "specificationSection";
    specificationSection.style.display = "none";

    const specificationTitle = document.createElement("h3");
    specificationTitle.textContent = "Especificações do problema";
    specificationSection.appendChild(specificationTitle);

    const externalCallCheckbox = createCheckbox(
      "externalCallCheckbox",
      "Aguardar chamado externo?"
    );
    externalCallCheckbox.style.display = "none";
    specificationSection.appendChild(externalCallCheckbox);

    const reminderCheckbox = createCheckbox(
      "reminderCheckbox",
      "Finalizar com lembrete"
    );
    reminderCheckbox.style.display = "none";
    specificationSection.appendChild(reminderCheckbox);

    const importantCheckbox = createCheckbox(
      "importantCheckbox",
      "Chamado importante"
    );
    importantCheckbox.style.display = "none";
    specificationSection.appendChild(importantCheckbox);

    const observationsTextarea = document.createElement("textarea");
    observationsTextarea.id = "observationsTextarea";
    observationsTextarea.placeholder = "Observações";
    observationsTextarea.rows = 3;
    observationsTextarea.style.display = "none";
    specificationSection.appendChild(observationsTextarea);

    sidebar.appendChild(specificationSection);

    const clientDataSection = document.createElement("div");
    clientDataSection.id = "clientDataSection";

    const clientDataTitle = document.createElement("h3");
    clientDataTitle.textContent = "Dados do cliente";
    clientDataSection.appendChild(clientDataTitle);

    const holderCheckbox = createCheckbox("holderCheckbox", "Fala com o titular");
    clientDataSection.appendChild(holderCheckbox);

    const speakerInput = document.createElement("input");
    speakerInput.type = "text";
    speakerInput.id = "speakerInput";
    speakerInput.placeholder = "Quem fala";
    speakerInput.style.display = "none";
    clientDataSection.appendChild(speakerInput);

    const relationshipSelect = createSelect(
      "relationshipSelect",
      "Grau de parentesco",
      [
        { value: "Cliente", text: "Não informado" },
        { value: "Esposo(a) do(a) titular", text: "Esposo(a) do(a) titular" },
        { value: "Mãe do(a) titular", text: "Mãe do(a) titular" },
        { value: "Pai do(a) titular", text: "Pai do(a) titular" },
        { value: "Filho(a) do(a) titular", text: "Filho(a) do(a) titular" },
        { value: "Neto(a) do(a) titular", text: "Neto(a) do(a) titular" },
        { value: "Amigo(a) do(a) titular", text: "Amigo(a) do(a) titular" },
        { value: "Funcionário(a) do(a) titular", text: "Funcionário(a) do(a) titular" },
        { value: "Namorado(a) do(a) titular", text: "Namorado(a) do(a) titular" },
        { value: "Irmão(ã) do(a) titular", text: "Irmão(ã) do(a) titular" },
        { value: "Sobrinho(a) do(a) titular", text: "Sobrinho(a) do(a) titular" },
        { value: "Avô(ó) do(a) titular", text: "Avô(ó) do(a) titular" },
        { value: "Genro/Nora do(a) titular", text: "Genro/Nora do(a) titular" },
        { value: "Cunhado(a) do(a) titular", text: "Cunhado(a) do(a) titular" },
        { value: "Enteado(a) do(a) titular", text: "Enteado(a) do(a) titular" },
        { value: "Tutor(a) do(a) titular", text: "Tutor(a) do(a) titular" },
        { value: "Sócio(a) do(a) titular", text: "Sócio(a) do(a) titular" },
        { value: "Vizinho(a) do(a) titular", text: "Vizinho(a) do(a) titular" },
        { value: "Padrasto/Madrasta do(a) titular", text: "Padrasto/Madrasta do(a) titular" },
        { value: "Parente do(a) titular", text: "Parente do(a) titular" },
      ]
    );
    relationshipSelect.style.display = "none";
    clientDataSection.appendChild(relationshipSelect);

    sidebar.appendChild(clientDataSection);

    const buttonContainer = document.createElement("div");
    buttonContainer.className = "button-container";
    buttonContainer.style.display = "none";

    const sendButton = document.createElement("button");
    sendButton.textContent = "Enviar";
    sendButton.className = "send-button";
    const editButton = document.createElement("button");
    editButton.textContent = "Editar antes de enviar";
    editButton.className = "edit-button";
    
    buttonContainer.appendChild(sendButton);
    buttonContainer.appendChild(editButton);
    sidebar.appendChild(buttonContainer);

    const previewSection = document.createElement("div");
    previewSection.id = "previewSection";
    previewSection.style.display = "none";

    const internalLabelPreview = document.createElement("div");
    internalLabelPreview.id = "internalLabelPreview";
    internalLabelPreview.className = "preview-item";
    previewSection.appendChild(internalLabelPreview);

    const externalLabelPreview = document.createElement("div");
    externalLabelPreview.id = "externalLabelPreview";
    externalLabelPreview.className = "preview-item";
    previewSection.appendChild(externalLabelPreview);

    const finalMessagePreview = document.createElement("div");
    finalMessagePreview.id = "finalMessagePreview";
    finalMessagePreview.className = "preview-item";
    previewSection.appendChild(finalMessagePreview);

    sidebar.appendChild(previewSection);

    const editModal = document.createElement("div");
    editModal.id = "editModal";
    editModal.className = "modal";
    editModal.style.display = "none";

    const modalContent = document.createElement("div");
    modalContent.className = "modal-content";

    const closeBtn = document.createElement("span");
    closeBtn.className = "close";
    closeBtn.innerHTML = "&times;";

    const modalTitle = document.createElement("h2");
    modalTitle.textContent = "Editar Mensagem Final";

    const editMessageTextarea = document.createElement("textarea");
    editMessageTextarea.id = "editMessageTextarea";

    const buttonContainerEdit = document.createElement("div");
    buttonContainerEdit.id = "buttonContainerEdit";

    const saveEditButton = document.createElement("button");
    saveEditButton.id = "saveEditButton";
    saveEditButton.textContent = "Salvar Edição";

    const cancelEditButton = document.createElement("button");
    cancelEditButton.id = "cancelEditButton";
    cancelEditButton.textContent = "Cancelar Edição";

    buttonContainerEdit.appendChild(saveEditButton);
    buttonContainerEdit.appendChild(cancelEditButton);

    modalContent.appendChild(closeBtn);
    modalContent.appendChild(modalTitle);
    modalContent.appendChild(editMessageTextarea);
    modalContent.appendChild(buttonContainerEdit);

    editModal.appendChild(modalContent);

    const overlay = document.createElement("div");
    overlay.id = "sidebar-overlay";
    document.body.appendChild(overlay);

    document.body.appendChild(editModal);


    return {
      sidebar,
      searchInput,
      clearButton,
      dropdown,
      overlay,
      specificationSection,
      externalCallCheckbox,
      reminderCheckbox,
      importantCheckbox,
      holderCheckbox,
      relationshipSelect,
      speakerInput,
      observationsTextarea,
      buttonContainer,
      sendButton, 
      editButton, 
      previewSection,
      internalLabelPreview,
      externalLabelPreview,
      finalMessagePreview,
      editModal,
      editMessageTextarea,
      saveEditButton,
      cancelEditButton,
      closeBtn,
    };
  }

  function createCheckbox(id, label) {
    const checkboxContainer = document.createElement("div");
    checkboxContainer.className = "checkbox-container";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.id = id;
    checkbox.className = "checkbox-input";

    const checkboxLabel = document.createElement("label");
    checkboxLabel.htmlFor = id;
    checkboxLabel.textContent = label;

    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(checkboxLabel);

    return checkboxContainer;
  }

  function createSelect(id, label, options) {
    const selectContainer = document.createElement("div");
    selectContainer.className = "select-container";

    const selectLabel = document.createElement("label");
    selectLabel.textContent = label;
    selectLabel.htmlFor = id;
    selectContainer.appendChild(selectLabel);

    const select = document.createElement("select");
    select.id = id;
    select.className = "custom-select";

    options.forEach(option => {
      const optionElement = document.createElement("option");
      optionElement.value = option.value;
      optionElement.textContent = option.text;
      select.appendChild(optionElement);
    });

    selectContainer.appendChild(select);

    return selectContainer;
  }

  function addStyles() {
    const style = document.createElement("style");
    style.textContent = `
      #openSidebarBtn {
        position: fixed;
        top: 112px;
        right: 20px;
        padding: 12px;
        background-color: #0858ce;
        border: none;
        cursor: move;
        z-index: 999;
        border-radius: 8px;
        transition: background-color 0.2s, transform 0.2s;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        user-select: none;
        touch-action: none;
      }

      #openSidebarBtn:hover {
        background-color: #001658;
        transform: scale(1.05);
      }

      #openSidebarBtn:active {
        cursor: grabbing;
      }

      #sidebar {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100%;
        background-color: #f0f4f9;
        transition: right 0.3s ease-in-out;
        box-shadow: -2px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        overflow-y: auto;
      }

      #sidebar.open {
        right: 0;
      }

      #sidebar header {
        color: white;
        padding: 48px 32px 61px 32px;
        font-size: 24px;
        font-weight: 600;
        min-height: 150px;
        text-align: center;
        background: #000C3E;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      #searchContainer {
        padding: 24px 20px;
        position: absolute;
        width: 100%;
        top: 104px;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: white;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .input-wrapper:focus-within {
        border-color: #2196F3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      #searchInput {
        width: 100%;
        padding: 12px 16px;
        font-size: 16px;
        border: none;
        border-radius: 10px;
        background-color: transparent;
      }

      #searchInput:focus {
        outline: none;
      }

      .clear-button {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        color: #6B7280;
        font-size: 24px;
        cursor: pointer;
        padding: 0 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.3s;
      }

      .clear-button:hover {
        color: #374151;
      }

      #dropdown {
        list-style-type: none;
        padding: 0;
        margin: 0;
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 10px;
        position: absolute;
        width: calc(100% - 40px);
        left: 20px;
        top: 180px;
        z-index: 1002;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #dropdown li {
        padding: 12px 32px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 14px;
        color: #1F2937;
      }

      #dropdown li:hover {
        background-color: #F3F4F6;
      }

      #dropdown::-webkit-scrollbar {
        width: 8px;
      }

      #dropdown::-webkit-scrollbar-track {
        background: #F3F4F6;
      }

      #dropdown::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 4px;
      }

      #dropdown::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
      }

      #sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(2px);
      }

      #specificationSection, #clientDataSection {
        background-color: #ffffff;
        margin: 40px 20px 12px;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      #specificationSection h3, #clientDataSection h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #000C3E;
        border-bottom: 2px solid #e0e7ff;
        padding-bottom: 8px;
      }

      .checkbox-container, .select-container {
        margin-top: 16px;
      }

      .checkbox-container label, .select-container label {
        display: inline-block;
        margin-left: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #4B5563;
      }

      .checkbox-input {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #D1D5DB;
        border-radius: 4px;
        outline: none;
        cursor: pointer;
        vertical-align: middle;
        transition: background-color 0.3s, border-color 0.3s;
      }

      .checkbox-input:checked {
        background-color: #2196F3;
        border-color: #2196F3;
      }

      .checkbox-input:checked::after {
        content: '✓';
        display: block;
        text-align: center;
        color: white;
        font-size: 14px;
        line-height: 18px;
      }

      .checkbox-input:focus {
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      .custom-select {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        background-color: white;
        color: #1F2937;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234B5563'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .custom-select:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      #speakerInput {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        background-color: white;
        color: #1F2937;
        margin-top: 12px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      #speakerInput:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      #observationsTextarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        background-color: white;
        color: #1F2937;
        margin-top: 12px;
        resize: vertical;
        min-height: 100px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      #observationsTextarea:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .button-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .send-button, .edit-button {
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
      }

      .send-button {
        background-color: #2196F3;
        color: white;
        border: none;
      }

      .send-button:hover {
        background-color: #1e88e5;
        transform: translateY(-2px);
      }

      .edit-button {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
      }

      .edit-button:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
      }

      .checkbox-container {
        display: flex;
        align-items: center;
        margin-top: 12px;
      }

      #specificationSection .checkbox-container {
        display: none;
      }

      #specificationSection.active .checkbox-container {
        display: flex;
      }

      #previewSection {
        background-color: #ffffff;
        margin: 20px;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .preview-item {
        margin-bottom: 12px;
        padding: 12px;
        background-color: #f0f4f9;
        border-radius: 8px;
        border: 1px solid #e0e7ff;
        transition: box-shadow 0.3s;
      }

      .preview-item h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #000C3E;
      }

      .preview-item p {
        font-size: 12px;
        color: #4B5563;
        line-height: 1.4;
        margin: 0;
      }

      .send-button:disabled, .edit-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      @media (max-width: 768px) {
        #sidebar {
          width: 100%;
          right: -100%;
        }

        #searchContainer {
          top: 60px;
        }

        #sidebar header {
          min-height: 120px;
          padding: 30px 20px 20px;
        }

        .button-container {
          flex-direction: column;
        }

        .send-button, .edit-button {
          width: 100%;
        }
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1003;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }

      #editMessageTextarea {
        width: 100%;
        height: 200px;
        margin-bottom: 20px;
        padding: 12px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
      }

      #editMessageTextarea:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      #buttonContainerEdit {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      #saveEditButton, #cancelEditButton {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
      }

      #saveEditButton {
        background-color: #10B981;
        color: white;
        border: none;
      }

      #saveEditButton:hover {
        background-color: #059669;
        transform: translateY(-2px);
      }

      #cancelEditButton {
        background-color: #F3F4F6;
        color: #111827;
        border: 1px solid #D1D5DB;
      }

      #cancelEditButton:hover {
        background-color: #E5E7EB;
        transform: translateY(-2px);
      }
    `;
    document.head.appendChild(style);
  }

  // Funções do Modal
  function openEditModal() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return console.error("openEditModal: elements não definido");
    
    // Prioriza a mensagem já editada ou constrói uma nova se for a primeira abertura
    const messageToEdit = window.ItemSelectorState.mensagemFinal || window.construirMensagemFinal();
    
    elements.editMessageTextarea.value = messageToEdit;
    elements.editModal.style.display = "block";
    elements.editMessageTextarea.focus();
    console.log("Modal de edição aberto.");
  }

  function closeEditModal() {
    const elements = window.ItemSelectorState.elements;
    if (elements?.editModal) elements.editModal.style.display = "none";
    console.log("Modal de edição fechado.");
  }

  function saveEdit() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return;

    // 1. Salva o valor da textarea na variável de estado que guarda a mensagem editada
    window.ItemSelectorState.mensagemFinal = elements.editMessageTextarea.value;
    
    // 2. Atualiza a pré-visualização para refletir a nova mensagem salva
    updatePreview();
    
    // 3. Fecha o modal
    closeEditModal();
    console.log("Mensagem editada salva no estado.");
  }


  function setupEventListeners() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return console.error("setupEventListeners: elements faltando");

    const {
      searchInput,
      clearButton,
      dropdown,
      overlay,
      specificationSection,
      externalCallCheckbox,
      reminderCheckbox,
      importantCheckbox,
      holderCheckbox,
      relationshipSelect,
      speakerInput,
      observationsTextarea,
      buttonContainer,
      previewSection,
      sidebar,
      editModal,
      editMessageTextarea,
      saveEditButton,
      cancelEditButton,
      editButton,
      closeBtn,
    } = elements;

    const openSidebarBtn = document.getElementById("openSidebarBtn");
    if (!openSidebarBtn) {
      console.error("Open sidebar button not found");
      return;
    }

    openSidebarBtn.addEventListener("click", () => {
      sidebar.classList.add("open");
      overlay.style.display = "block";
      updateAvailableTags();
      filterAndDisplayItems();
      console.log(
        "Tags atuais da página:",
        Array.from(window.ItemSelectorState.availableTags)
      );
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.style.display = "none";
      closeEditModal();
    });

    searchInput.addEventListener("input", () => {
      filterAndDisplayItems();
      dropdown.style.display = "block";
      searchInput.style.borderRadius = "10px 10px 0 0";
    });

    searchInput.addEventListener("focus", () => {
      dropdown.style.display = "block";
      searchInput.style.borderRadius = "10px 10px 0 0";
    });

    clearButton.addEventListener("click", e => {
      e.stopPropagation();
      searchInput.value = "";
      window.ItemSelectorState.selectedItem = null;
      window.ItemSelectorState.mensagemFinal = "";
      clearButton.style.display = "none";
      specificationSection.style.display = "none";
      buttonContainer.style.display = "none";
      previewSection.style.display = "none";
      closeEditModal();
      resetElementsToDefault();
      filterAndDisplayItems();
      updateButtonState();
      console.log("Item selecionado:", window.ItemSelectorState.selectedItem);
    });

    document.addEventListener("click", e => {
      if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = "none";
        searchInput.style.borderRadius = "10px";
      }
    });

    externalCallCheckbox
      .querySelector("input")
      .addEventListener("change", updatePreview);
    reminderCheckbox
      .querySelector("input")
      .addEventListener("change", updatePreview);
    importantCheckbox
      .querySelector("input")
      .addEventListener("change", updatePreview);

    holderCheckbox.querySelector("input").addEventListener("change", e => {
      speakerInput.style.display = e.target.checked ? "none" : "block";
      relationshipSelect.style.display = e.target.checked ? "none" : "block";
      updatePreview();
    });
    speakerInput.addEventListener("input", updatePreview);
    relationshipSelect.querySelector("select").addEventListener("change", updatePreview);
    observationsTextarea.addEventListener("input", updatePreview);
    
    // Listener do Modal de Edição
    editButton.addEventListener("click", e => {
      e.preventDefault();
      console.log("Botão 'Editar antes de enviar' clicado.");
      openEditModal(); 
    });

    // Listeners dos botões do Modal
    closeBtn.addEventListener("click", closeEditModal);
    saveEditButton.addEventListener("click", saveEdit);
    cancelEditButton.addEventListener("click", closeEditModal);

    // Set initial state for holderCheckbox
    holderCheckbox.querySelector("input").checked = true;
    speakerInput.style.display = "none";
    relationshipSelect.style.display = "none";

    const sendButton = buttonContainer.querySelector(".send-button");
    if (sendButton) {
      sendButton.addEventListener("click", e => {
        e.preventDefault();
        console.log("Enviando...");
        try {
          window.tagExt(); // Call tagExt function here
          console.log("tagResult antes do envio:", window.tagResult);
          executarAutomacao().catch(err => console.error("exec automacao:", err));
        } catch (err) {
          console.error("Erro ao chamar tagExt/exec:", err);
        }
      });
    }

    updateButtonState();
  }

  function setupDraggableButton() {
    const button = document.getElementById("openSidebarBtn");
    if (!button) return;

    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let xOffset = 0;
    let yOffset = 0;

    function onPointerDown(clientX, clientY) {
      isDragging = true;
      startX = clientX - xOffset;
      startY = clientY - yOffset;
      button.style.transition = "none";
    }

    function onPointerMove(clientX, clientY) {
      if (!isDragging) return;
      const currentX = clientX - startX;
      const currentY = clientY - startY;
      xOffset = currentX;
      yOffset = currentY;
      setTranslate(currentX, currentY, button);
    }

    function onPointerUp() {
      isDragging = false;
      button.style.transition = "";
    }

    function setTranslate(xPos, yPos, el) {
      el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
    }

    // Mouse events
    button.addEventListener("mousedown", e => onPointerDown(e.clientX, e.clientY), false);
    document.addEventListener("mousemove", e => onPointerMove(e.clientX, e.clientY), false);
    document.addEventListener("mouseup", onPointerUp, false);

    // Touch events
    button.addEventListener("touchstart", e => {
      const t = e.touches[0];
      onPointerDown(t.clientX, t.clientY);
    }, { passive: true });
    document.addEventListener("touchmove", e => {
      if (!isDragging) return;
      const t = e.touches[0];
      onPointerMove(t.clientX, t.clientY);
    }, { passive: true });
    document.addEventListener("touchend", onPointerUp, false);
  }

  function init() {
    addStyles();
    window.ItemSelectorState.elements = createElements();
    if (!window.ItemSelectorState.elements) {
      console.error("Falha ao criar elementos");
      return;
    }
    // append sidebar element now
    document.body.appendChild(window.ItemSelectorState.elements.sidebar);
    setupEventListeners();
    setupDraggableButton();
    loadAndFilterData();

    // Adicionar callback padrão
    window.ItemSelector.onItemSelected(item => {
      console.log("Novo item selecionado:", item);
    });
  }

  async function loadAndFilterData() {
    try {
      const response = await fetch(
        "https://raw.githubusercontent.com/Gusttavop/RevanAntigo/refs/heads/main/Problemas.json"
      );
      window.ItemSelectorState.jsonData = await response.json();
      console.log("JSON Data carregado:", window.ItemSelectorState.jsonData);
      filterAndDisplayItems();
    } catch (error) {
      console.error("Erro ao carregar os dados:", error);
      // fallback: manter jsonData vazio e permitir busca
    }
  }

  function normalizeString(str = "") {
    return String(str)
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "");
  }

  function filterAndDisplayItems() {
    if (!window.ItemSelectorState.elements?.searchInput) {
      console.error("Search input element not found");
      return;
    }
    const searchTerm = normalizeString(
      window.ItemSelectorState.elements.searchInput.value
    );
    const filteredItems = (window.ItemSelectorState.jsonData || []).filter(item => {
      const matchesSearch = normalizeString(item.titulo).includes(searchTerm);
      const matchesTag =
        item.infra === "Geral" ||
        window.ItemSelectorState.availableTags.has(mapInfraToTag(item.infra));
      return matchesSearch && matchesTag;
    });

    displayItems(filteredItems);
  }

  function mapInfraToTag(infra) {
    const mapping = {
      Fibra: "Fibra",
      IPTV: "IPTV",
      Telefonia: "Telefonia",
      FWA: "FWA",
      Geral: "Geral",
    };
    return mapping[infra] || "Geral";
  }

  function displayItems(items) {
    if (!validateElements()) return;

    const dd = window.ItemSelectorState.elements.dropdown;
    dd.innerHTML = "";
    items.forEach(item => {
      const li = document.createElement("li");
      li.textContent = item.titulo;
      li.addEventListener("click", () => {
        resetElementsToDefault();
        window.ItemSelectorState.selectedItem = item;
        window.ItemSelectorState.mensagemFinal = ""; 
        updateUIOnSelection(item);

        console.log("Selected Item:", window.ItemSelector.getSelectedItem());
        console.log("Formatted Message:", window.ItemSelector.getFormattedMessage());
        console.log("Form Data:", window.ItemSelector.getFormData());

        if (typeof window.ItemSelectorState.onItemSelectedCallback === "function") {
          window.ItemSelectorState.onItemSelectedCallback(item);
        }
      });
      dd.appendChild(li);
    });
  }

  function validateElements() {
    const elems = window.ItemSelectorState.elements;
    const requiredElements = [
      "dropdown",
      "searchInput",
      "clearButton",
      "specificationSection",
      "externalCallCheckbox",
      "reminderCheckbox",
      "importantCheckbox",
      "observationsTextarea",
      "buttonContainer",
      "previewSection",
      "editModal",
      "editMessageTextarea",
      "saveEditButton",
      "cancelEditButton",
    ];

    for (const element of requiredElements) {
      if (!elems[element]) {
        console.error(`Required element missing: ${element}`);
        return false;
      }
    }
    return true;
  }

  function updateUIOnSelection(item) {
    const elements = window.ItemSelectorState.elements;
    // resetElementsToDefault(); // Já chamado antes de updateUIOnSelection

    elements.searchInput.value = item.titulo || "";
    elements.clearButton.style.display = "flex";
    elements.dropdown.style.display = "none";
    elements.searchInput.style.borderRadius = "10px";

    elements.specificationSection.style.display = "block";

    if (item.externo) {
      elements.externalCallCheckbox.style.display = "block";
      elements.reminderCheckbox.style.display = "none";
      const cb = elements.externalCallCheckbox.querySelector("input");
      if (cb) cb.checked = !!item.aguardar;
    } else {
      elements.externalCallCheckbox.style.display = "none";
      elements.reminderCheckbox.style.display = "block";
      const cb = elements.reminderCheckbox.querySelector("input");
      if (cb) cb.checked = !!item.lembrete;
    }

    elements.importantCheckbox.style.display = "block";
    elements.observationsTextarea.style.display = "block";
    elements.buttonContainer.style.display = "flex";
    elements.previewSection.style.display = "block";

    updateButtonState();
    updatePreview();

    // Call tagExt and log
    try {
      window.tagExt();
      console.log("tagResult após seleção:", window.tagResult);
    } catch (err) {
      console.error("Erro ao executar tagExt:", err);
      window.tagResult = false;
    }
  }

  function updatePreview() {
    if (!window.ItemSelectorState.selectedItem) return;

    const s = window.ItemSelectorState.selectedItem;
    window.ItemSelectorState.elements.internalLabelPreview.innerHTML = `<h4>Etiqueta Interna:</h4><p>${s.etiqueta || ""}</p>`;
    window.ItemSelectorState.elements.externalLabelPreview.innerHTML = `<h4>Etiqueta Externa:</h4><p>${s.etiqueta_externo || "N/A"}</p>`;

    const mensagemFinal = window.construirMensagemFinal(); 
    window.ItemSelectorState.elements.finalMessagePreview.innerHTML = `<h4>Mensagem Final:</h4><p>${mensagemFinal}</p>`;
  }

  function updateButtonState() {
    const sendButton =
      window.ItemSelectorState.elements.buttonContainer.querySelector(
        ".send-button"
      );
    const editButton =
      window.ItemSelectorState.elements.buttonContainer.querySelector(
        ".edit-button"
      );
    if (sendButton && editButton) {
      const isEnabled = !!window.ItemSelectorState.selectedItem;
      sendButton.disabled = !isEnabled;
      editButton.disabled = !isEnabled;
    }
  }

  function updateAvailableTags() {
    window.ItemSelectorState.availableTags.clear();
    document
      .querySelectorAll("div.tags > div.tag > nz-tag > span")
      .forEach(tag => {
        if (tag && tag.textContent) window.ItemSelectorState.availableTags.add(tag.textContent.trim());
      });
  }

  function resetElementsToDefault() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return;
    try {
      // Reset checkboxes
      elements.externalCallCheckbox.querySelector("input").checked = false;
      elements.reminderCheckbox.querySelector("input").checked = false;
      elements.importantCheckbox.querySelector("input").checked = false;
      elements.holderCheckbox.querySelector("input").checked = true;
    } catch (e) {
      // ignore if structure changed
    }

    // Reset input and textarea
    elements.speakerInput.value = "";
    elements.observationsTextarea.value = "";
    elements.editMessageTextarea.value = "";

    // Reset select
    const sel = elements.relationshipSelect.querySelector("select");
    if (sel) sel.selectedIndex = 0;
    window.ItemSelectorState.mensagemFinal = ""; 
    closeEditModal();
  }

  function closeSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    if (sidebar) {
      sidebar.classList.remove("open");
    }
    if (overlay) {
      overlay.style.display = "none";
    }
  }

  init();
  
  // Função auxiliar para confirmar a finalização (clica em "Sim, finalizar")
  async function confirmarFinalizacao() {
      console.log("Tentando confirmar finalização...");
      try {
          // XPATH para o botão vermelho de confirmação "Sim, finalizar"
          const xpathConfirmar = "//button[span[contains(text(), 'Sim, finalizar')]]";
          
          await esperarEClicar(xpathConfirmar, 50, 10000);
          console.log("Confirmação de finalização automática bem-sucedida.");
      } catch (error) {
          console.log("Modal de confirmação não encontrado ou não necessário. Continuando...");
          // Não lança erro, pois o modal pode não aparecer em todos os cenários.
      }
  }


  // Função principal de automação
  async function executarAutomacao() {
    closeSidebar();
    window.tagResult = false;
    if (document.getElementById("upload")) {
      const toggle = document.getElementById("toggle_upload");
      if (toggle) toggle.click();
    }

    // Usa a mensagem final, que agora prioriza a versão editada (se houver)
    const msgF = window.construirMensagemFinal(); 
    const textArea = document.querySelector(".text-area");
    if (textArea) {
      textArea.value = msgF;
      textArea.dispatchEvent(new Event("input", { bubbles: true }));
    }

    const importantCheckbox = document.getElementById("importantCheckbox");
    if (importantCheckbox && importantCheckbox.checked) {
      const importantButton = document.getElementById("important");
      if (importantButton) {
        importantButton.click();
        console.log("Botão 'important' clicado");
      } else {
        console.log("Elemento 'important' não encontrado");
      }
    }

    const sendBtn = document.getElementById("send_button");
    if (sendBtn) {
      sendBtn.click();
      console.log("Mensagem enviada");
    } else {
      console.warn("Botão de envio não encontrado (#send_button)");
    }

    // Verify if tag already exists before adding (case-insensitive)
    const existingTags = document.querySelectorAll(
      "div.tags > div.tag > nz-tag > span"
    );
    const desiredTag = window.ItemSelectorState.selectedItem?.etiqueta || "";
    const tagExists = Array.from(existingTags).some(
      tag => tag.textContent.trim().toLowerCase() === desiredTag.toLowerCase()
    );

    if (!tagExists && desiredTag) {
      console.log("Adicionando etiqueta");
      try {
        await adicionarEtiqueta();
      } catch (err) {
        console.error("Falha ao adicionar etiqueta:", err);
        window.tagResult = false;
      }
    } else {
      console.log("Etiqueta já existe ou não definida, pulando adição");
      window.tagResult = true;
    }

    if (window.ItemSelectorState.selectedItem?.externo) {
      console.log("Finalizando caso externo");
      await finalizarExterno();
      await confirmarFinalizacao(); // CONFIRMAÇÃO AUTOMÁTICA ADICIONADA AQUI
    } else if (document.getElementById("reminderCheckbox")?.checked) {
      console.log("Adicionando lembrete");
      await adicionarLembrete();
    } else {
      console.log("Finalizando caso interno");
      await finalizarInterno();
      await confirmarFinalizacao(); // CONFIRMAÇÃO AUTOMÁTICA ADICIONADA AQUI
    }

    console.log("Automação concluída com sucesso");
  }

  // Função para adicionar etiqueta
  async function adicionarEtiqueta() {
    try {
      const tagElement = await esperarElemento(
        "//nz-tag[contains(@class, 'editable-tag')]",
        100, // Otimizado: 150ms -> 50ms
        5000
      );

      if (!tagElement) {
        throw new Error("Tag element not found");
      }

      tagElement.click();
      console.log("Tag element clicked successfully");

      const tagInput = await esperarElemento(
        "//*[@id='tags']/div/div/ul/li/input",
        50, // Otimizado: 150ms -> 50ms
        5000
      );

      if (!tagInput) {
        throw new Error("Tag input element not found");
      }

      tagInput.click();
      tagInput.value = window.ItemSelectorState.selectedItem.etiqueta;
      tagInput.dispatchEvent(new Event("input", { bubbles: true }));

      const etiquetaInterna = window.ItemSelectorState.selectedItem.etiqueta;
      console.log(`Attempting to select tag: ${etiquetaInterna}`);

      await esperarEClicar(
        `//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(normalize-space(.), '${etiquetaInterna}')]`,
        100, // Otimizado: 150ms -> 50ms
        10000
      );

      await esperarElemento(
        `//li[contains(@class, 'ant-select-selection__choice')]//div[contains(text(), '${etiquetaInterna}')]`,
        100, // Otimizado: 150ms -> 50ms
        5000
      );

      const concluirButton = document.querySelector(
        '[data-testid="btn-Concluir"]'
      );
      if (!concluirButton) {
        throw new Error("Concluir button not found");
      }

      concluirButton.click();
      console.log("Tag added and Concluir button clicked");

      window.tagResult = true;
    } catch (error) {
      console.error("Error in adicionarEtiqueta:", error);
      window.tagResult = false;
      throw error;
    }
  }

  // Função para finalizar caso externo (mantida)
  async function finalizarExterno() {
    const etiquetaExterno =
      window.ItemSelectorState.selectedItem.etiqueta_externo || "";
    const forward = document.getElementById("forward");
    if (forward) forward.click();

    // Otimizado: 300ms -> 100ms
    await new Promise(resolve => setTimeout(resolve, 200));

    if (document.getElementById("externalCallCheckbox")?.checked) {
      try {
        const xpathSwitch = '//lib-input-switch//button[@class="ant-switch"]';
        const xpathVerificacao =
          '//lib-input-switch//button[@class="ant-switch ant-switch-checked"]';
        await clicarComTentativas(xpathSwitch, xpathVerificacao);
        console.log("Switch clicado e verificado com sucesso!");
      } catch (error) {
        console.error("Erro ao clicar no switch:", error);
      }

      // Otimizado: Remoção de delay (100ms) desnecessário, o próximo await fará o trabalho.
    }

    await clicarComTentativas(
      "//nz-select[@id='sector']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    await esperarElemento(
      "//ul[contains(@class, 'ant-select-dropdown-menu') and not(contains(@style, 'display: none'))]",
      100, // Otimizado: 150ms -> 50ms
      20000
    );

    await esperarEClicar(
      "//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'suporte externo')]",
      100, // Otimizado: 150ms -> 50ms
      20000
    );

    // Otimizado: 200ms -> 50ms
    await new Promise(resolve => setTimeout(resolve, 100));

    await clicarComTentativas(
      "//nz-select[@id='problem']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    const problemInput = document.evaluate(
      "//nz-select[@id='problem']//input",
      document,
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null
    ).singleNodeValue;
    if (problemInput) {
      problemInput.value = etiquetaExterno;
      problemInput.dispatchEvent(new Event("input", { bubbles: true }));
    }

    await esperarEClicar(
      `//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${etiquetaExterno.toLowerCase()}')]`,
      100, // Otimizado: 150ms -> 50ms
      20000
    );

    await esperarElemento(
      `//li[contains(@class, 'ant-select-selection__choice')]//div[contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${etiquetaExterno.toLowerCase()}')]`,
      100, // Otimizado: 150ms -> 50ms
      20000
    );

    const servicoExterno = window.ItemSelectorState.selectedItem.servico || "";

    await esperarElementoHabilitado("//nz-select[@id='service']", 300, 20000); // Otimizado: 500ms -> 50ms

    await clicarComTentativas(
      "//nz-select[@id='problem']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    // Otimizado: 200ms -> 50ms
    await new Promise(resolve => setTimeout(resolve, 100));

    await clicarComTentativas(
      "//nz-select[@id='service']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    const serviceInput = document.evaluate(
      "//nz-select[@id='service']//input",
      document,
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null
    ).singleNodeValue;
    if (serviceInput) {
      serviceInput.value = servicoExterno;
      serviceInput.dispatchEvent(new Event("input", { bubbles: true }));
    }

    await esperarEClicar(
      `//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${servicoExterno.toLowerCase()}')]`,
      100, // Otimizado: 150ms -> 50ms
      10000
    );

    await esperarElemento(
      `//div[contains(@class, 'ant-select-selection-selected-value') and contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${servicoExterno.toLowerCase()}')]`,
      100, // Otimizado: 150ms -> 50ms
      10000
    );

    const continuar = document.querySelector('[data-testid="btn-Continuar"]');
    if (continuar) continuar.click();
    
    // A confirmação é chamada na função pai (executarAutomacao)
  }

  // Função para adicionar lembrete
  async function adicionarLembrete() {
    const more = document.querySelector(".more");
    if (more) more.click();
    const item = document
      .evaluate(
        "//nz-list-item[span[text()='Adicionar lembrete']]",
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      )
      .singleNodeValue;
    if (item) item.click();
    
    // Otimizado: Uso de esperarElemento para garantir que o modal abriu e o input está pronto
    const tituloInput = await esperarElemento("#titulo", 50, 5000); 

    if (tituloInput) {
      tituloInput.click();
      tituloInput.value = "Fazer retorno";
      tituloInput.dispatchEvent(new Event("input", { bubbles: true }));
    }
    const concluir = document
      .evaluate(
        "//span[contains(text(), 'Concluir')]",
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      )
      .singleNodeValue;
    if (concluir) concluir.click();
  }

  // Função para finalizar caso interno
  async function finalizarInterno() {
    // Otimizado: 400ms -> 100ms
    await new Promise(resolve => setTimeout(resolve, 200));

    const more = document.querySelector(".more");
    if (more) more.click();
    
    // Otimizado: Usando esperarElemento para o item 'Finalizar'
    const finalizar = await esperarElemento(
        "//nz-list-item[span[text()='Finalizar']]",
        50,
        5000
    );

    if (finalizar) finalizar.click();
    
    // A confirmação é chamada na função pai (executarAutomacao)
  }

  // Função auxiliar para esperar e clicar em um elemento
  // Otimizado: Default intervalo = 50ms
  async function esperarEClicar(xpath, intervalo = 50, timeout = 10000) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();
      const intervalId = setInterval(() => {
        const elements = document.evaluate(
          xpath,
          document,
          null,
          XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
          null
        );
        for (let i = 0; i < elements.snapshotLength; i++) {
          const element = elements.snapshotItem(i);
          if (element) {
            clearInterval(intervalId);
            element.click();
            console.log(`Elemento clicado: ${xpath}`);
            resolve();
            return;
          }
        }
        if (Date.now() - startTime > timeout) {
          clearInterval(intervalId);
          console.error(`Timeout esperando pelo elemento: ${xpath}`);
          reject(new Error(`Timeout esperando pelo elemento: ${xpath}`));
        }
      }, intervalo);
    });
  }

  // Otimizado: Default intervalo = 50ms
  async function esperarElemento(xpath, intervalo = 50, timeout = 10000) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();
      const intervalId = setInterval(() => {
        const element = document.evaluate(
          xpath,
          document,
          null,
          XPathResult.FIRST_ORDERED_NODE_TYPE,
          null
        ).singleNodeValue;
        if (element) {
          clearInterval(intervalId);
          resolve(element);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(intervalId);
          reject(new Error(`Timeout esperando pelo elemento: ${xpath}`));
        }
      }, intervalo);
    });
  }

  // Nova função auxiliar para clicar com tentativas
  // Otimizado: Default intervalo reduzido para 100ms (era 200ms)
  async function clicarComTentativas(
    xpathParaClicar,
    xpathParaVerificar,
    maxTentativas = 60,
    intervalo = 150 // Otimizado: 200ms -> 100ms
  ) {
    for (let i = 0; i < maxTentativas; i++) {
      const elementoParaClicar = document.evaluate(
        xpathParaClicar,
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      ).singleNodeValue;
      if (elementoParaClicar) {
        elementoParaClicar.click();

        // Pausa de 100ms após o clique é mantida por segurança para renderização do Angular/Ant Design
        await new Promise(resolve => setTimeout(resolve, 100));

        const elementoVerificacao = document.evaluate(
          xpathParaVerificar,
          document,
          null,
          XPathResult.FIRST_ORDERED_NODE_TYPE,
          null
        ).singleNodeValue;
        if (elementoVerificacao) {
          console.log("Clique bem-sucedido no input do sector.");
          return;
        }
      }

      await new Promise(resolve => setTimeout(resolve, intervalo));
    }

    throw new Error("Falha ao clicar no input do sector após várias tentativas.");
  }

  // Otimizado: Default intervalo = 50ms
  async function esperarElementoHabilitado(
    xpath,
    intervalo = 200, // Otimizado: 500ms -> 50ms
    timeout = 10000
  ) {
    const startTime = Date.now();
    while (Date.now() - startTime < timeout) {
      const element = document.evaluate(
        xpath,
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      ).singleNodeValue;
      if (element && !element.classList.contains("ant-select-disabled")) {
        return element;
      }
      await new Promise(resolve => setTimeout(resolve, intervalo));
    }
    throw new Error(`Timeout esperando pelo elemento habilitado: ${xpath}`);
  }

  // Otimizado: Default intervalo = 50ms
  async function esperarElementoClicavel(
    xpath,
    intervalo = 50,
    timeout = 10000
  ) {
    return await esperarElemento(xpath, intervalo, timeout);
  }

})();
