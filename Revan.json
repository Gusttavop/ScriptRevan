// ==UserScript==
// @name         Máscara de Atendimento (corrigido + mais rápido)
// @namespace    http://tampermonkey.net/
// @version      1.4.2
// @description  Adiciona um botão flutuante que abre um sidebar com overlay controlado por uma variável global. Correções no modal de edição e otimizações de velocidade.
// @author       Você
// @match        https://revan-atendimento.brisanet.net.br/*
// @grant        GM_addStyle
// ==/UserScript==

(function () {
  "use strict";

  // Global state
  window.ItemSelectorState = {
    jsonData: [],
    availableTags: new Set(),
    selectedItem: null,
    mensagemFinal: "",
    elements: null,
    onItemSelectedCallback: null,
  };

  // Padroniza flag de resultado de tag
  window.tagResult = false;

  // --- Função para extrair tags da página (tolerante) ---
  window.tagExt = () => {
    if (!window.ItemSelectorState?.selectedItem) {
      console.log("tagExt: nenhum item selecionado");
      return false;
    }
    const spans = Array.from(document.querySelectorAll("div.tags > div.tag > nz-tag > span"));
    const tags = spans.map(t => (t && t.textContent ? t.textContent.trim() : null)).filter(Boolean);
    globalThis.globalAvailableTags = new Set(tags);
    const selectedTag = window.ItemSelectorState.selectedItem?.etiqueta;
    const resultTag = selectedTag ? globalThis.globalAvailableTags.has(selectedTag) : false;
    window.tagResult = resultTag;
    console.log("tagExt -> tags extraídas:", tags, "selected:", selectedTag, "available:", resultTag);
    return resultTag;
  };

  // Interface pública
  window.ItemSelector = {
    getSelectedItem: () => window.ItemSelectorState.selectedItem || null,
    getFormattedMessage: () => window.construirMensagemFinal() || "",
    getFormData: () => {
      const s = window.ItemSelectorState;
      if (!s.selectedItem || !s.elements) return null;
      const el = s.elements;
      return {
        item: s.selectedItem,
        isHolder: !!el.holderCheckbox.querySelector("input")?.checked,
        speaker: el.speakerInput.value || "",
        relationship: el.relationshipSelect.querySelector("select")?.value || "",
        observations: el.observationsTextarea.value || "",
        isExternalCall: !!el.externalCallCheckbox.querySelector("input")?.checked,
        hasReminder: !!el.reminderCheckbox.querySelector("input")?.checked,
        isImportant: !!el.importantCheckbox.querySelector("input")?.checked,
        finalMessage: window.construirMensagemFinal(),
      };
    },
    onItemSelected: cb => {
      if (typeof cb === "function") window.ItemSelectorState.onItemSelectedCallback = cb;
    },
  };

  // Construir a mensagem final
  window.construirMensagemFinal = () => {
    if (!window.ItemSelectorState.selectedItem || !window.ItemSelectorState.elements) return "";
    if (window.ItemSelectorState.mensagemFinal) return window.ItemSelectorState.mensagemFinal;

    const el = window.ItemSelectorState.elements;
    let inicio = "";
    try {
      if (el.holderCheckbox.querySelector("input").checked) inicio = "Próprio titular - ";
      else if (el.speakerInput.value) {
        const rel = el.relationshipSelect.querySelector("select")?.value || "";
        inicio = `${el.speakerInput.value} - ${rel} - `;
      } else inicio = "Cliente - ";
    } catch (e) {
      inicio = "Cliente - ";
    }
    const corpo = window.ItemSelectorState.selectedItem.mensagem || "";
    const obs = (el.observationsTextarea.value || "").trim();
    const finalObs = obs ? ` Observação: ${obs}` : "";
    return `${inicio}${corpo}${finalObs}`.trim();
  };

  // ---------- UI creation ----------
  function createElements() {
    // botão flutuante
    const button = document.createElement("button");
    button.id = "openSidebarBtn";
    button.setAttribute("aria-label", "Abrir Máscara de Atendimento");
    button.innerHTML =
      '<svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="#fff"><path d="M3 6h18v2H3zM3 11h12v2H3zM3 16h12v2H3z"/></svg>';
    document.body.appendChild(button);

    // sidebar
    const sidebar = document.createElement("div");
    sidebar.id = "sidebar";

    const header = document.createElement("header");
    header.textContent = "Máscara de Atendimento";
    sidebar.appendChild(header);

    // search container
    const searchContainer = document.createElement("div");
    searchContainer.id = "searchContainer";
    const inputWrapper = document.createElement("div");
    inputWrapper.className = "input-wrapper";
    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.id = "searchInput";
    searchInput.placeholder = "Selecione um problema";
    const clearButton = document.createElement("button");
    clearButton.className = "clear-button";
    clearButton.innerHTML = "×";
    clearButton.style.display = "none";
    inputWrapper.appendChild(searchInput);
    inputWrapper.appendChild(clearButton);
    searchContainer.appendChild(inputWrapper);
    sidebar.appendChild(searchContainer);

    const dropdown = document.createElement("ul");
    dropdown.id = "dropdown";
    dropdown.style.display = "none";
    sidebar.appendChild(dropdown);

    // specification section
    const specificationSection = document.createElement("div");
    specificationSection.id = "specificationSection";
    specificationSection.style.display = "none";
    const specificationTitle = document.createElement("h3");
    specificationTitle.textContent = "Especificações do problema";
    specificationSection.appendChild(specificationTitle);
    const externalCallCheckbox = createCheckbox("externalCallCheckbox", "Aguardar chamado externo?");
    externalCallCheckbox.style.display = "none";
    const reminderCheckbox = createCheckbox("reminderCheckbox", "Finalizar com lembrete");
    reminderCheckbox.style.display = "none";
    const importantCheckbox = createCheckbox("importantCheckbox", "Chamado importante");
    importantCheckbox.style.display = "none";
    const observationsTextarea = document.createElement("textarea");
    observationsTextarea.id = "observationsTextarea";
    observationsTextarea.placeholder = "Observações";
    observationsTextarea.rows = 3;
    observationsTextarea.style.display = "none";
    // garante que textarea é editável
    observationsTextarea.removeAttribute("readonly");
    specificationSection.appendChild(externalCallCheckbox);
    specificationSection.appendChild(reminderCheckbox);
    specificationSection.appendChild(importantCheckbox);
    specificationSection.appendChild(observationsTextarea);
    sidebar.appendChild(specificationSection);

    // client data section
    const clientDataSection = document.createElement("div");
    clientDataSection.id = "clientDataSection";
    const clientDataTitle = document.createElement("h3");
    clientDataTitle.textContent = "Dados do cliente";
    clientDataSection.appendChild(clientDataTitle);
    const holderCheckbox = createCheckbox("holderCheckbox", "Fala com o titular");
    clientDataSection.appendChild(holderCheckbox);
    const speakerInput = document.createElement("input");
    speakerInput.type = "text";
    speakerInput.id = "speakerInput";
    speakerInput.placeholder = "Quem fala";
    speakerInput.style.display = "none";
    clientDataSection.appendChild(speakerInput);
    const relationshipSelect = createSelect("relationshipSelect", "Grau de parentesco", [
      { value: "Cliente", text: "Não informado" },
      { value: "Esposo(a) do(a) titular", text: "Esposo(a) do(a) titular" },
      { value: "Mãe do(a) titular", text: "Mãe do(a) titular" },
      { value: "Pai do(a) titular", text: "Pai do(a) titular" },
      { value: "Filho(a) do(a) titular", text: "Filho(a) do(a) titular" },
      { value: "Neto(a) do(a) titular", text: "Neto(a) do(a) titular" },
      { value: "Amigo(a) do(a) titular", text: "Amigo(a) do(a) titular" },
      { value: "Funcionário(a) do(a) titular", text: "Funcionário(a) do(a) titular" },
      { value: "Namorado(a) do(a) titular", text: "Namorado(a) do(a) titular" },
      { value: "Irmão(ã) do(a) titular", text: "Irmão(ã) do(a) titular" },
      { value: "Sobrinho(a) do(a) titular", text: "Sobrinho(a) do(a) titular" },
      { value: "Avô(ó) do(a) titular", text: "Avô(ó) do(a) titular" },
      { value: "Genro/Nora do(a) titular", text: "Genro/Nora do(a) titular" },
      { value: "Cunhado(a) do(a) titular", text: "Cunhado(a) do(a) titular" },
      { value: "Enteado(a) do(a) titular", text: "Enteado(a) do(a) titular" },
      { value: "Tutor(a) do(a) titular", text: "Tutor(a) do(a) titular" },
      { value: "Sócio(a) do(a) titular", text: "Sócio(a) do(a) titular" },
      { value: "Vizinho(a) do(a) titular", text: "Vizinho(a) do(a) titular" },
      { value: "Padrasto/Madrasta do(a) titular", text: "Padrasto/Madrasta do(a) titular" },
      { value: "Parente do(a) titular", text: "Parente do(a) titular" },
    ]);
    relationshipSelect.style.display = "none";
    clientDataSection.appendChild(relationshipSelect);
    sidebar.appendChild(clientDataSection);

    // button container
    const buttonContainer = document.createElement("div");
    buttonContainer.className = "button-container";
    buttonContainer.style.display = "none";
    const sendButton = document.createElement("button");
    sendButton.textContent = "Enviar";
    sendButton.className = "send-button";
    const editButton = document.createElement("button");
    editButton.textContent = "Editar antes de enviar";
    editButton.className = "edit-button";
    buttonContainer.appendChild(sendButton);
    buttonContainer.appendChild(editButton);
    sidebar.appendChild(buttonContainer);

    // preview
    const previewSection = document.createElement("div");
    previewSection.id = "previewSection";
    previewSection.style.display = "none";
    const internalLabelPreview = document.createElement("div");
    internalLabelPreview.id = "internalLabelPreview";
    internalLabelPreview.className = "preview-item";
    const externalLabelPreview = document.createElement("div");
    externalLabelPreview.id = "externalLabelPreview";
    externalLabelPreview.className = "preview-item";
    const finalMessagePreview = document.createElement("div");
    finalMessagePreview.id = "finalMessagePreview";
    finalMessagePreview.className = "preview-item";
    previewSection.appendChild(internalLabelPreview);
    previewSection.appendChild(externalLabelPreview);
    previewSection.appendChild(finalMessagePreview);
    sidebar.appendChild(previewSection);

    // edit modal (append to body so overlays don't block)
    const editModal = document.createElement("div");
    editModal.id = "editModal";
    editModal.className = "modal";
    editModal.style.display = "none";
    editModal.style.zIndex = "10050"; // garantir acima do overlay

    const modalContent = document.createElement("div");
    modalContent.className = "modal-content";

    const closeBtn = document.createElement("span");
    closeBtn.className = "close";
    closeBtn.innerHTML = "&times;";
    closeBtn.style.cursor = "pointer";
    closeBtn.onclick = closeEditModal;

    const modalTitle = document.createElement("h2");
    modalTitle.textContent = "Editar Mensagem Final";

    const editMessageTextarea = document.createElement("textarea");
    editMessageTextarea.id = "editMessageTextarea";
    // garante que textarea é editável
    editMessageTextarea.removeAttribute("readonly");
    editMessageTextarea.style.width = "100%";
    editMessageTextarea.style.height = "200px";

    const buttonContainerEdit = document.createElement("div");
    buttonContainerEdit.id = "buttonContainerEdit";
    const saveEditButton = document.createElement("button");
    saveEditButton.id = "saveEditButton";
    saveEditButton.textContent = "Salvar Edição";
    const cancelEditButton = document.createElement("button");
    cancelEditButton.id = "cancelEditButton";
    cancelEditButton.textContent = "Cancelar Edição";

    buttonContainerEdit.appendChild(saveEditButton);
    buttonContainerEdit.appendChild(cancelEditButton);

    modalContent.appendChild(closeBtn);
    modalContent.appendChild(modalTitle);
    modalContent.appendChild(editMessageTextarea);
    modalContent.appendChild(buttonContainerEdit);
    editModal.appendChild(modalContent);
    document.body.appendChild(editModal);

    // overlay
    const overlay = document.createElement("div");
    overlay.id = "sidebar-overlay";
    overlay.style.display = "none";
    document.body.appendChild(overlay);

    return {
      sidebar,
      searchInput,
      clearButton,
      dropdown,
      overlay,
      specificationSection,
      externalCallCheckbox,
      reminderCheckbox,
      importantCheckbox,
      holderCheckbox,
      relationshipSelect,
      speakerInput,
      observationsTextarea,
      buttonContainer,
      previewSection,
      internalLabelPreview,
      externalLabelPreview,
      finalMessagePreview,
      editModal,
      editMessageTextarea,
      buttonContainerEdit,
      saveEditButton,
      cancelEditButton,
      sendButton,
      editButton,
    };
  }

  function createCheckbox(id, label) {
    const c = document.createElement("div");
    c.className = "checkbox-container";
    const input = document.createElement("input");
    input.type = "checkbox";
    input.id = id;
    input.className = "checkbox-input";
    const lbl = document.createElement("label");
    lbl.htmlFor = id;
    lbl.textContent = label;
    c.appendChild(input);
    c.appendChild(lbl);
    return c;
  }

  function createSelect(id, label, options) {
    const container = document.createElement("div");
    container.className = "select-container";
    const lbl = document.createElement("label");
    lbl.textContent = label;
    lbl.htmlFor = id;
    container.appendChild(lbl);
    const select = document.createElement("select");
    select.id = id;
    select.className = "custom-select";
    options.forEach(opt => {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.text;
      select.appendChild(o);
    });
    container.appendChild(select);
    return container;
  }

  // estilos (corrigidos)
  function addStyles() {
    const css = `
      #openSidebarBtn { position: fixed; top: 112px; right: 20px; padding: 10px; background-color: #6c7a89; border: none; cursor: move; z-index: 10060; border-radius: 8px; color: #fff; }
      #sidebar { position: fixed; top: 0; right: -420px; width: 420px; height: 100%; background:#f7fafc; transition: right 0.22s ease-in-out; box-shadow:-2px 0 20px rgba(0,0,0,0.12); z-index:10055; overflow-y:auto;}
      #sidebar.open { right: 0; }
      #sidebar header { color: white; padding: 28px 20px; font-size: 20px; font-weight:600; background:#00173a; text-align:center; }
      #searchContainer { padding:16px 16px; position:relative; top:0; }
      .input-wrapper { position:relative; display:flex; align-items:center; border:1px solid #e2e8f0; border-radius:10px; background:white; }
      #searchInput { width:100%; padding:10px 14px; border:none; border-radius:10px; font-size:14px; }
      .clear-button { position:absolute; right:8px; background:none; border:none; font-size:18px; cursor:pointer; }
      #dropdown { list-style:none; padding:0; margin:0; max-height:240px; overflow:auto; background:white; border:1px solid #e2e8f0; border-radius:8px; position:absolute; width:calc(100% - 32px); left:16px; top:76px; z-index:10070; display:none; }
      #dropdown li { padding:10px 16px; cursor:pointer; border-bottom:1px solid #f1f5f9; }
      #dropdown li:hover { background:#f1f5f9; }
      #sidebar-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.45); z-index:10040; }
      .modal { display:none; position:fixed; z-index:10050; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
      .modal-content { background:#fff; margin:8% auto; padding:18px; width:90%; max-width:560px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.18); }
      .close { float:right; font-size:28px; font-weight:bold; cursor:pointer; }
      .button-container { display:flex; justify-content:center; gap:10px; margin:12px 16px; }
      .send-button, .edit-button { padding:10px 14px; border-radius:8px; cursor:pointer; border:none; background:#2563eb; color:#fff; font-weight:600; }
      .edit-button { background:#6b7280; }
      .preview-item { margin:8px 16px; padding:10px; background:#fff; border-radius:8px; border:1px solid #e6eef8; }
      /* ensure textarea editable and on top */
      #editModal textarea { width:100%; min-height:160px; font-size:14px; padding:10px; box-sizing:border-box; }
    `;
    const s = document.createElement("style");
    s.textContent = css;
    document.head.appendChild(s);
  }

  // ---------- Event listeners / behavior ----------
  function setupEventListeners() {
    const el = window.ItemSelectorState.elements;
    if (!el) return console.error("elements missing");

    const openSidebarBtn = document.getElementById("openSidebarBtn");
    if (!openSidebarBtn) return console.error("open button missing");

    openSidebarBtn.addEventListener("click", () => {
      el.sidebar.classList.add("open");
      el.overlay.style.display = "block";
      updateAvailableTags();
      filterAndDisplayItems();
    });

    el.overlay.addEventListener("click", () => {
      el.sidebar.classList.remove("open");
      el.overlay.style.display = "none";
      closeEditModal();
    });

    el.searchInput.addEventListener("input", () => {
      filterAndDisplayItems();
      el.dropdown.style.display = "block";
      el.searchInput.style.borderRadius = "10px 10px 0 0";
    });

    el.searchInput.addEventListener("focus", () => {
      el.dropdown.style.display = "block";
      el.searchInput.style.borderRadius = "10px 10px 0 0";
    });

    el.clearButton.addEventListener("click", e => {
      e.stopPropagation();
      el.searchInput.value = "";
      window.ItemSelectorState.selectedItem = null;
      el.clearButton.style.display = "none";
      el.specificationSection.style.display = "none";
      el.buttonContainer.style.display = "none";
      el.previewSection.style.display = "none";
      closeEditModal();
      resetElementsToDefault();
      filterAndDisplayItems();
      updateButtonState();
    });

    document.addEventListener("click", e => {
      if (!el.searchInput.contains(e.target) && !el.dropdown.contains(e.target)) {
        el.dropdown.style.display = "none";
        el.searchInput.style.borderRadius = "10px";
      }
    });

    // checkboxes and inputs
    const extInp = el.externalCallCheckbox.querySelector("input");
    const remInp = el.reminderCheckbox.querySelector("input");
    const impInp = el.importantCheckbox.querySelector("input");
    const holderInp = el.holderCheckbox.querySelector("input");

    if (extInp) extInp.addEventListener("change", updatePreview);
    if (remInp) remInp.addEventListener("change", updatePreview);
    if (impInp) impInp.addEventListener("change", updatePreview);
    if (holderInp) holderInp.addEventListener("change", e => {
      el.speakerInput.style.display = e.target.checked ? "none" : "block";
      el.relationshipSelect.style.display = e.target.checked ? "none" : "block";
      updatePreview();
    });

    el.speakerInput.addEventListener("input", updatePreview);
    el.relationshipSelect.addEventListener("change", updatePreview);
    el.observationsTextarea.addEventListener("input", updatePreview);

    // modal buttons
    el.saveEditButton.addEventListener("click", saveEdit);
    el.cancelEditButton.addEventListener("click", closeEditModal);
    el.editButton.addEventListener("click", e => {
      e.preventDefault();
      openEditModal();
    });

    // send action
    el.sendButton.addEventListener("click", async e => {
      e.preventDefault();
      window.tagExt();
      console.log("tagResult before send:", window.tagResult);
      try {
        await executarAutomacao();
      } catch (err) {
        console.error("Erro na automação:", err);
      }
    });

    // set holder default
    holderInp.checked = true;
    el.speakerInput.style.display = "none";
    el.relationshipSelect.style.display = "none";

    updateButtonState();
  }

  // draggable button (suporta touch)
  function setupDraggableButton() {
    const button = document.getElementById("openSidebarBtn");
    if (!button) return;
    let dragging = false;
    let startX = 0, startY = 0, xOffset = 0, yOffset = 0;
    function down(x, y) { dragging=true; startX=x - xOffset; startY=y - yOffset; button.style.transition='none'; }
    function move(x,y){ if(!dragging) return; xOffset = x - startX; yOffset = y - startY; button.style.transform = `translate3d(${xOffset}px, ${yOffset}px, 0)`; }
    function up(){ dragging=false; button.style.transition=''; }
    button.addEventListener('mousedown', e=>down(e.clientX,e.clientY));
    document.addEventListener('mousemove', e=>move(e.clientX,e.clientY));
    document.addEventListener('mouseup', up);
    button.addEventListener('touchstart', e=>{ const t=e.touches[0]; down(t.clientX,t.clientY); }, {passive:true});
    document.addEventListener('touchmove', e=>{ const t=e.touches[0]; move(t.clientX,t.clientY); }, {passive:true});
    document.addEventListener('touchend', up);
  }

  function saveEdit() {
    const el = window.ItemSelectorState.elements;
    if (!el) return;
    window.ItemSelectorState.mensagemFinal = el.editMessageTextarea.value || "";
    updatePreview();
    closeEditModal();
  }

  function openEditModal() {
    const el = window.ItemSelectorState.elements;
    if (!el) return;
    el.editModal.style.display = "block";
    el.editMessageTextarea.value = window.construirMensagemFinal() || "";
    // foco para permitir edição imediata
    setTimeout(() => {
      try { el.editMessageTextarea.focus(); el.editMessageTextarea.select(); } catch (e) {}
    }, 50);
  }

  function closeEditModal() {
    const el = window.ItemSelectorState.elements;
    if (!el) return;
    el.editModal.style.display = "none";
  }

  // init
  function init() {
    addStyles();
    window.ItemSelectorState.elements = createElements();
    if (!window.ItemSelectorState.elements) return console.error("Falha ao criar elementos");
    document.body.appendChild(window.ItemSelectorState.elements.sidebar);
    setupEventListeners();
    setupDraggableButton();
    loadAndFilterData();
    window.ItemSelector.onItemSelected(item => console.log("Novo item selecionado:", item));
  }

  // dados
  async function loadAndFilterData() {
    try {
      const response = await fetch("https://raw.githubusercontent.com/Gusttavop/RevanAntigo/refs/heads/main/Problemas.json");
      window.ItemSelectorState.jsonData = await response.json();
      console.log("JSON Data carregado:", window.ItemSelectorState.jsonData?.length || 0);
      filterAndDisplayItems();
    } catch (err) {
      console.error("Erro ao carregar JSON:", err);
    }
  }

  // normalização de strings
  function normalizeString(str="") {
    return String(str).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"");
  }

  // filtra e mostra itens
  function filterAndDisplayItems() {
    const el = window.ItemSelectorState.elements;
    if (!el?.searchInput) return;
    const searchTerm = normalizeString(el.searchInput.value || "");
    const data = window.ItemSelectorState.jsonData || [];
    const filtered = data.filter(item => {
      const matchesSearch = normalizeString(item.titulo || "").includes(searchTerm);
      const infraTag = mapInfraToTag(item.infra);
      const matchesTag = item.infra === "Geral" || window.ItemSelectorState.availableTags.has(infraTag);
      return matchesSearch && matchesTag;
    });
    displayItems(filtered);
  }

  function mapInfraToTag(infra) {
    const m = { Fibra:"Fibra", IPTV:"IPTV", Telefonia:"Telefonia", FWA:"FWA", Geral:"Geral" };
    return m[infra] || "Geral";
  }

  function displayItems(items) {
    if (!validateElements()) return;
    const el = window.ItemSelectorState.elements;
    el.dropdown.innerHTML = "";
    items.forEach(item => {
      const li = document.createElement("li");
      li.textContent = item.titulo;
      li.addEventListener("click", () => {
        resetElementsToDefault();
        window.ItemSelectorState.selectedItem = item;
        updateUIOnSelection(item);
        console.log("Selected Item:", window.ItemSelector.getSelectedItem());
        console.log("Formatted Message:", window.ItemSelector.getFormattedMessage());
        console.log("Form Data:", window.ItemSelector.getFormData());
        if (typeof window.ItemSelectorState.onItemSelectedCallback === "function") window.ItemSelectorState.onItemSelectedCallback(item);
      });
      el.dropdown.appendChild(li);
    });
  }

  function validateElements() {
    const el = window.ItemSelectorState.elements;
    const required = ["dropdown","searchInput","clearButton","specificationSection","externalCallCheckbox","reminderCheckbox","importantCheckbox","observationsTextarea","buttonContainer","previewSection","editModal","editMessageTextarea","saveEditButton","cancelEditButton","sendButton","editButton"];
    for (const r of required) {
      if (!el[r]) { console.error("Elemento requerido faltando:", r); return false; }
    }
    return true;
  }

  function updateUIOnSelection(item) {
    const el = window.ItemSelectorState.elements;
    resetElementsToDefault();
    el.searchInput.value = item.titulo || "";
    el.clearButton.style.display = "flex";
    el.dropdown.style.display = "none";
    el.searchInput.style.borderRadius = "10px";
    el.specificationSection.style.display = "block";

    if (item.externo) {
      el.externalCallCheckbox.style.display = "block";
      el.reminderCheckbox.style.display = "none";
      const cb = el.externalCallCheckbox.querySelector("input");
      if (cb) cb.checked = !!item.aguardar;
    } else {
      el.externalCallCheckbox.style.display = "none";
      el.reminderCheckbox.style.display = "block";
      const cb = el.reminderCheckbox.querySelector("input");
      if (cb) cb.checked = !!item.lembrete;
    }

    el.importantCheckbox.style.display = "block";
    el.observationsTextarea.style.display = "block";
    el.buttonContainer.style.display = "flex";
    el.previewSection.style.display = "block";

    updateButtonState();
    updatePreview();

    // run tagExt but don't block UI
    try { window.tagExt(); console.log("tagResult após seleção:", window.tagResult); } catch (e) { console.error("tagExt erro:", e); }
  }

  function updatePreview() {
    if (!window.ItemSelectorState.selectedItem || !window.ItemSelectorState.elements) return;
    const s = window.ItemSelectorState.selectedItem;
    const el = window.ItemSelectorState.elements;
    el.internalLabelPreview.innerHTML = `<h4>Etiqueta Interna:</h4><p>${s.etiqueta || ""}</p>`;
    el.externalLabelPreview.innerHTML = `<h4>Etiqueta Externa:</h4><p>${s.etiqueta_externo || "N/A"}</p>`;
    const msg = window.construirMensagemFinal();
    el.finalMessagePreview.innerHTML = `<h4>Mensagem Final:</h4><p>${msg}</p>`;
  }

  function updateButtonState() {
    const el = window.ItemSelectorState.elements;
    if (!el) return;
    const send = el.sendButton;
    const edit = el.editButton;
    const enabled = !!window.ItemSelectorState.selectedItem;
    if (send) send.disabled = !enabled;
    if (edit) edit.disabled = !enabled;
  }

  function updateAvailableTags() {
    window.ItemSelectorState.availableTags.clear();
    const nodes = document.querySelectorAll("div.tags > div.tag > nz-tag > span");
    nodes.forEach(n => {
      if (n && n.textContent) window.ItemSelectorState.availableTags.add(n.textContent.trim());
    });
  }

  function resetElementsToDefault() {
    const el = window.ItemSelectorState.elements;
    if (!el) return;
    try {
      el.externalCallCheckbox.querySelector("input").checked = false;
      el.reminderCheckbox.querySelector("input").checked = false;
      el.importantCheckbox.querySelector("input").checked = false;
      el.holderCheckbox.querySelector("input").checked = true;
    } catch (e) {}
    el.speakerInput.value = "";
    el.observationsTextarea.value = "";
    el.editMessageTextarea.value = "";
    const sel = el.relationshipSelect.querySelector("select");
    if (sel) sel.selectedIndex = 0;
    window.ItemSelectorState.mensagemFinal = "";
    closeEditModal();
  }

  function closeSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    if (sidebar) sidebar.classList.remove("open");
    if (overlay) overlay.style.display = "none";
  }

  // inicializa
  init();

  // ---------- Automação (mais rápida / com timeouts menores) ----------
  async function executarAutomacao() {
    closeSidebar();
    window.tagResult = false;

    if (document.getElementById("upload")) {
      const toggle = document.getElementById("toggle_upload");
      if (toggle) toggle.click();
    }

    // copiar mensagem para textarea
    const msgF = window.construirMensagemFinal();
    const textArea = document.querySelector(".text-area");
    if (textArea) {
      textArea.value = msgF;
      textArea.dispatchEvent(new Event("input", { bubbles: true }));
    }

    // important
    const importantCheckbox = document.getElementById("importantCheckbox");
    if (importantCheckbox && importantCheckbox.checked) {
      const importantButton = document.getElementById("important");
      if (importantButton) {
        importantButton.click();
        console.log("Botão 'important' clicado");
      } else {
        console.log("Elemento 'important' não encontrado");
      }
    }

    // send (tenta encontrar botão)
    const sendBtn = document.getElementById("send_button");
    if (sendBtn) {
      sendBtn.click();
      console.log("Mensagem enviada (click em #send_button)");
    } else {
      console.warn("#send_button não encontrado; continue workflow");
    }

    // Verificar tags existentes (case-insensitive)
    const existingTags = Array.from(document.querySelectorAll("div.tags > div.tag > nz-tag > span")).map(n => (n.textContent || "").trim().toLowerCase());
    const desiredTag = (window.ItemSelectorState.selectedItem?.etiqueta || "").trim();
    const tagExists = desiredTag ? existingTags.includes(desiredTag.toLowerCase()) : false;

    if (!tagExists && desiredTag) {
      console.log("Adicionando etiqueta:", desiredTag);
      try {
        await adicionarEtiqueta(); // se falhar, vai para catch
      } catch (err) {
        console.error("Falha ao adicionar etiqueta:", err);
        window.tagResult = false;
      }
    } else {
      console.log("Etiqueta já existe ou indefinida; pulando adição");
      window.tagResult = true;
    }

    // Finalizações
    if (window.ItemSelectorState.selectedItem?.externo) {
      console.log("Finalizando caso externo (fluxo rápido)");
      await finalizarExterno();
    } else if (document.getElementById("reminderCheckbox")?.checked) {
      console.log("Adicionando lembrete");
      await adicionarLembrete();
    } else {
      console.log("Finalizando caso interno");
      await finalizarInterno();
    }

    console.log("Automação concluída");
  }

  // Função para adicionar etiqueta (otimizada)
  async function adicionarEtiqueta() {
    try {
      // esperar elemento editável de tag
      const tagElement = await esperarElemento("//nz-tag[contains(@class, 'editable-tag')]", 100, 6000);
      if (!tagElement) throw new Error("editable-tag não encontrada");
      tagElement.click();
      // esperar input
      const tagInput = await esperarElemento("//*[@id='tags']/div/div/ul/li/input", 100, 5000);
      if (!tagInput) throw new Error("input de tags não encontrado");
      tagInput.click();
      tagInput.value = window.ItemSelectorState.selectedItem.etiqueta;
      tagInput.dispatchEvent(new Event("input", { bubbles: true }));
      const etiquetaInterna = window.ItemSelectorState.selectedItem.etiqueta;
      // tentar selecionar item no dropdown (mais rápido)
      await esperarEClicar(`//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(normalize-space(.), '${etiquetaInterna}')]`, 100, 6000);
      // aguardar escolha
      await esperarElemento(`//li[contains(@class, 'ant-select-selection__choice')]//div[contains(text(), '${etiquetaInterna}')]`, 100, 5000);
      const concluirButton = document.querySelector('[data-testid="btn-Concluir"]');
      if (!concluirButton) throw new Error("Concluir button not found");
      concluirButton.click();
      window.tagResult = true;
      console.log("Etiqueta adicionada com sucesso:", etiquetaInterna);
    } catch (error) {
      window.tagResult = false;
      console.error("adicionarEtiqueta erro:", error);
      throw error;
    }
  }

  // finalizar externo (mais rápido onde possível)
  async function finalizarExterno() {
    const etiquetaExterno = window.ItemSelectorState.selectedItem?.etiqueta_externo || "";
    const forward = document.getElementById("forward");
    if (forward) forward.click();
    await sleep(140);

    // switch do externalCall
    const extChk = document.getElementById("externalCallCheckbox");
    if (extChk && extChk.checked) {
      try {
        const xpathSwitch = '//lib-input-switch//button[@class="ant-switch"]';
        const xpathVerificacao = '//lib-input-switch//button[@class="ant-switch ant-switch-checked"]';
        await clicarComTentativas(xpathSwitch, xpathVerificacao, 40, 120);
        console.log("Switch external clicado");
      } catch (err) {
        console.warn("Falha ao clicar switch external:", err);
      }
      await sleep(80);
    }

    // selecionar sector
    await clicarComTentativas("//nz-select[@id='sector']//input", "//ul[contains(@class, 'ant-select-dropdown-menu')]", 40, 120);
    await esperarElemento("//ul[contains(@class, 'ant-select-dropdown-menu') and not(contains(@style, 'display: none'))]", 80, 8000);
    await esperarEClicar("//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'suporte externo')]", 120, 8000);

    await sleep(160);

    // problema
    await clicarComTentativas("//nz-select[@id='problem']//input", "//ul[contains(@class, 'ant-select-dropdown-menu')]", 40, 120);
    const problemInput = document.evaluate("//nz-select[@id='problem']//input", document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    if (problemInput) { problemInput.value = etiquetaExterno; problemInput.dispatchEvent(new Event("input", { bubbles: true })); }
    await esperarEClicar(`//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz'),'${etiquetaExterno.toLowerCase()}')]`, 120, 8000);
    await esperarElemento(`//li[contains(@class, 'ant-select-selection__choice')]//div[contains(translate(text(),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz'),'${etiquetaExterno.toLowerCase()}')]`, 120, 8000);

    const servicoExterno = window.ItemSelectorState.selectedItem?.servico || "";
    await esperarElementoHabilitado("//nz-select[@id='service']", 250, 10000);

    // abrir service e selecionar
    await clicarComTentativas("//nz-select[@id='service']//input", "//ul[contains(@class, 'ant-select-dropdown-menu')]", 40, 120);
    const serviceInput = document.evaluate("//nz-select[@id='service']//input", document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    if (serviceInput) { serviceInput.value = servicoExterno; serviceInput.dispatchEvent(new Event("input", { bubbles: true })); }
    await esperarEClicar(`//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.),'ABCDEFGHIJKLMNOPQRSTUVWXYZ','abcdefghijklmnopqrstuvwxyz'),'${servicoExterno.toLowerCase()}')]`, 120, 8000);

    const continuar = document.querySelector('[data-testid="btn-Continuar"]');
    if (continuar) continuar.click();
    console.log("Fluxo externo finalizado (tentativa rápida).");
  }

  // adicionar lembrete (igual, com sleeps menores)
  async function adicionarLembrete() {
    const more = document.querySelector(".more");
    if (more) more.click();
    await sleep(120);
    const add = document.evaluate("//nz-list-item[span[text()='Adicionar lembrete']]", document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    if (add) add.click();
    await sleep(80);
    const tituloInput = document.getElementById("titulo");
    if (tituloInput) { tituloInput.click(); tituloInput.value = "Fazer retorno"; tituloInput.dispatchEvent(new Event("input",{bubbles:true})); }
    const concluir = document.evaluate("//span[contains(text(), 'Concluir')]", document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    if (concluir) concluir.click();
  }

  async function finalizarInterno() {
    await sleep(120);
    const more = document.querySelector(".more");
    if (more) more.click();
    await sleep(80);
    const finalizar = document.evaluate("//nz-list-item[span[text()='Finalizar']]", document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    if (finalizar) finalizar.click();
  }

  // helpers
  function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

  async function esperarEClicar(xpath, intervalo = 120, timeout = 10000) {
    return new Promise((resolve, reject) => {
      const start = Date.now();
      const id = setInterval(() => {
        const nodes = document.evaluate(xpath, document, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
        for (let i = 0; i < nodes.snapshotLength; i++) {
          const el = nodes.snapshotItem(i);
          if (el) { clearInterval(id); try { el.click(); } catch (e) {} resolve(); return; }
        }
        if (Date.now() - start > timeout) { clearInterval(id); reject(new Error("Timeout esperarEClicar: " + xpath)); }
      }, intervalo);
    });
  }

  async function esperarElemento(xpath, intervalo = 100, timeout = 8000) {
    return new Promise((resolve, reject) => {
      const start = Date.now();
      const id = setInterval(() => {
        const el = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        if (el) { clearInterval(id); resolve(el); return; }
        if (Date.now() - start > timeout) { clearInterval(id); reject(new Error("Timeout esperarElemento: " + xpath)); }
      }, intervalo);
    });
  }

  async function clicarComTentativas(xpathParaClicar, xpathParaVerificar, maxTentativas = 40, intervalo = 120) {
    for (let i = 0; i < maxTentativas; i++) {
      const el = document.evaluate(xpathParaClicar, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
      if (el) {
        try { el.click(); } catch (e) {}
        await sleep(80);
        const ver = document.evaluate(xpathParaVerificar, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        if (ver) return;
      }
      await sleep(intervalo);
    }
    throw new Error("Falha ao clicarComTentativas: " + xpathParaClicar);
  }

  async function esperarElementoHabilitado(xpath, intervalo = 200, timeout = 8000) {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      const el = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
      if (el && !el.classList.contains("ant-select-disabled")) return el;
      await sleep(intervalo);
    }
    throw new Error("Timeout esperarElementoHabilitado: " + xpath);
  }

})();
